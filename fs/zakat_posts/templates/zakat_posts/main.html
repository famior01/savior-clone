{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}
<!--************** Including Bootstrap ****************-->

{% block title %}Zakat Posts{% endblock title %}


{% block content %}
<div style = 'margin-top:30px;' class='ui container fluid'>
    <div class="ui grid">
    <div class="row">
        <!--Zakat Form-->
        <div class=" eleven wide column ">
            <div class="ui blue raised segment">
                <form  id='postform' method="POST" enctype="multipart/form-data" class='ui form'>
                    {% csrf_token %}
                    {{ form.as_table }}
                    <button class="ui button primary" name="submit_p_form"  type="submit">Submit</button>
                </form>         
            </div>
        </div>
        {% comment %} {% include 'zakat_posts/form.html' %} {% endcomment %}
        {% comment %} <script type="text/javascript" src="{% static 'zakat_posts/form.js' %}"></script> {% endcomment %}

        <!--Instructions Eng & Urdu-->
        <div class="five wide column">
            <div class= 'ui red raised segment'>
                {% comment %} <h3>Instructions to fill form in two languages</h3>
                <button class="ui button b_English">English</button>
                <button class="ui button b_Urdu">Urdu</button> {% endcomment %}
                <details>
                    <summary>
                        <strong>Instructions in English</strong>
                    </summary>
                        <div class='ui play details-content'>
                        <audio controls>
                            <source src='/static/audios/video1_eng.mp3'>
                        </audio>
                        <audio controls>
                            <source src='/static/audios/video2_eng.mp3'>
                        </audio>
                        </div>
                    </details>
                
                    <details>
                        <summary>
                            <strong>Instructions in Urdu</strong>
                        </summary>
                            <div class='details-content'>
                            <audio controls>
                                <source src='/static/audios/video1_urdu.mp3'>
                            </audio>
                            <audio controls>
                                <source src='/static/audios/video2_urdu.mp3'>
                            </audio>
                            </div>
                        </details>
                </div>
        </div>      

    </div>
    {% comment %} <div id='Post-Box'></div> {% endcomment %}

    {% for obj in qs %}
    {% if obj.varified >= 0 and  not obj.satisfied %}
        <div class="row" id='buttons'>
            <div class=" eleven wide column ">
                <div class="ui blue raised segment">
                    {% if request.user == obj.creator.user %}
                    <a class="ui black right ribbon label">Post # {{ obj.post_number }}</a>
                    {% endif %}
                    <!--Herder line-->
                    <div class="ui grid">
                        <div class="row">
                            <div class="left floated  column eight wide fluid">
                                <!--Profile picture and created time-->
                                <a href="{% url 'profiles:myprofile' %}" >
                                <img class="ui avatar image" src={{obj.creator.avatar.url}}> </a>
                                {{ obj.creator}} {{obj.creator.last_name}}
                                <br>({{ obj.created|timesince}} ago)
                            </div>

                            <div class="right floated column eight wide fluid ">
                                {% if request.user == obj.creator.user %}
                                    <a href="{% url 'zakat_posts:post-update' obj.pk %}"><button class="ui button bwhite-lg ">Update</button></a>
                                    <a href="{% url 'zakat_posts:post-delete' obj.pk %}"><button class="ui button  bwhite-lg ">Delete</button></a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <hr>

                    <!--video 1-->
                    <div class="ui grid">
                        <div class="row">
                            <div class="column eight wide">
                                {% if obj.video1 %}
                                <a href="{{obj.video1.url}}">  
                                    <video width="320" height="240" controls>
                                        <source src="{{obj.video1.url}}" type="video/mp4">
                                        {% comment %} <source src="{{obj.video1.url}}" type="video/mp4"> {% endcomment %}
                                    </video>
                                </a>
                            {% endif %}
                            </div>

                            <!--video 1-->
                            <div class="column eight wide">
                                {% if obj.video2 %}
                                <a href="{{obj.video2.url}}">  
                                    <video width="320" height="240" controls>
                                        <source src="{{obj.video2.url}}" type="video/mp4">
                                        {% comment %} <source src="{{obj.video2.url}}" type="video/mp4"> {% endcomment %}
                                    </video>
                                </a>
                            {% endif %}
                            </div>
                        </div>
                    </div>
                    <hr>

                    <!--Content-->
                    <div class="content">
                        <p> {{ obj.content }} </p>
                    </div>
                    <hr>

                    <!--Commentes-->
                    <form action="{% url 'zakat_posts:create_comment' %}" method="POST"  id='{{obj.id}}' class='commentForm' >
                        {% csrf_token %}
                        <input type="hidden" name="post_id" value={{obj.id}}>
                        {{ c_form }}    
                        <button type="submit"  class="ui primary button commentbtn{{obj.id}}">Send</button>

                    </form>
                    {% include "zakat_posts/comment.html" %}
                    {% comment %} <script type="text/javascript" src="{% static 'zakat_posts/comment.js' %}"></script> {% endcomment %}

                    <hr>
                    <!--Show Comments-->
                    <details>
                        <summary  id='comment_total{{obj.id}}'>{{ obj.num_comments }} Comments</summary>

                        <div class="details-content">
                                {% if obj.zakat_posts_comments.all %}
                                    
                                    {% for c in obj.zakat_posts_comments.all %}
                                        <div class="ui green raised segment" id='c_body'>
                                            <img class="ui avatar image" src={{c.user.avatar.url}}>
                                            <span>{{ c.user }}</span>
                                            <div class='mt-5' >{{ c.body }}</div>
                                        </div>
                                    {% endfor %}
            
                                {% endif %}
                        </div>
                    </details>

                </div>
            </div>
            <div class="five wide column">
                <div class= 'ui black raised segment'>
                    <div class="ui grid">
                    <div class="row">
                    <div class="column eight wide fluid">
                        <div class="ui items">
                            <!--UpVote-->
                            <div class="item">
                                <form action="{% url 'zakat_posts:upvote' %}" method="POST" class='upvote-form' id='{{obj.id}}'>
                                    {% csrf_token %}
                                    <input type="hidden" name="post_id" value={{obj.id}}>
                                    <button type="submit" class="ui upvote_btn upvote-btn{{obj.id}}">
                                        <div class="p-2 rounded-full text-black">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" width="35" height="60">
                                                <path d="M318 177.5c3.8-8.8 2-19-4.6-26l-136-144C172.9 2.7 166.6 0 160 0s-12.9 2.7-17.4 7.5l-136 144c-6.6 7-8.4 17.2-4.6 26S14.4 192 24 192h88l0 288c0 17.7 14.3 32 32 32h32c17.7 0 32-14.3 32-32l0-288h88c9.6 0 18.2-5.7 22-14.5z"/></svg>
                                        </div>
                                    </button>
                                    <h2 class="upvote-count{{obj.id}}">{{obj.upvote}}</h2>
                                </form>
                            </div>
                            <!--DownVote-->
                            <div class="item">
                                <form action="{% url 'zakat_posts:downvote' %}" method="POST" class='downvote-form' id='{{obj.id}}'>
                                    {% csrf_token %}
                                    <input type="hidden" name="post_id" value={{obj.id}}>
                                    <button type="submit" class="ui upvote_btn downvote-btn{{obj.id}}">
                                        <div class="">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" width="35" height="60"><path d="M318 334.5c3.8 8.8 2 19-4.6 26l-136 144c-4.5 4.8-10.8 7.5-17.4 7.5s-12.9-2.7-17.4-7.5l-136-144c-6.6-7-8.4-17.2-4.6-26S14.4 320 24 320h88l0-288c0-17.7 14.3-32 32-32h32c17.7 0 32 14.3 32 32l0 288h88c9.6 0 18.2 5.7 22 14.5z"/></svg>
                                        </div>
                                    </button>
                                    <h2 class="downvote-count{{obj.id}}"><b>{{obj.downvote}} </b></h2>
                                </form>
                            </div>
                            
                            <script type="text/javascript" src="{% static 'zakat_posts/buttons.js' %}"></script>

                            <!--Pay-->
                            <div class='item'>
                                <button class='ui primary button'>Pay</button>
                            </div>
                        </div>
                    </div>
                    <div class="column eight wide fluid">
                        <div class="item">
                            <!--NO of varified badge-->
                            <div class='item'>
                                <h2><strong>
                                    <a class="item">
                                        <div class="ui red horizontal label"><h5>AI Varification</h5></div><br>
                                        {{ obj.varified }}%
                                    </a>
                                </strong></h2>
                            </div>
                            <!--Needed Money-->
                            <div class="item">
                                <h2><strong>
                                    <a class="item">
                                        <div class="ui red horizontal label"><h5>Needed Money</h5></div>
                                        {{ obj.needed_money }}
                                    </a>
                                </strong></h2>
                            </div>

                            <!--Paid money-->
                            <div class="item">
                                <h2><strong>
                                    <a class="item">
                                        <div class="ui red horizontal label"><h5>Paid Money</h5></div>
                                        <br>
                                        {{ obj.paid }}
                                    </a>
                                </strong></h2>
                            </div>
                            <!--Satisfied-->
                            <div class="item">
                                <h2><strong>
                                    <a class="item">
                                        <div class="ui red horizontal label"><h5>Satisfied</h5></div>
                                        <br>
                                        {% if obj.satisfied %}
                                            <i class="check circle icon"></i>
                                        {% else %}
                                            <i class="times circle icon"></i>
                                        {% endif %}
                                    </a>
                                </strong></h2>        
                            </div>
                        </div>
                    
                    </div>
                    </div>
                    </div>
                </div>
            </div> 
        </div>
    {% endif %}
    {% endfor %}
</div>
</div>
{% endblock content %}



<script>
// clicking on the upvote button
$('.upvote-form').submit(function(e){
    e.preventDefault()
    
    const post_id = $(this).attr('id')
    const url = $(this).attr('action')
    
    $.ajax({
        type: 'POST',
        url: url,
        data: {
            'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val(),
            'post_id':post_id,
        }, 
        success: function(data) {
            console.log(data['upvote'], '*************')
            if (parseInt(data['upvote']) > 0) {
                console.log(parseInt(data['upvote']), '*************')
                $(`.upvote-count${post_id}`).html(parseInt(data['upvote']))
            }
            else {
                $(`.upvote-count${post_id}`).html(0)
                console.log(parseInt(data['upvote']), '*************')
            }
        }
    })
    })
    
    
    
    // downvote button
    $('.downvote-form').submit(function(e){
        e.preventDefault()
        const post_id = $(this).attr('id')
        const url = $(this).attr('action')
    
        $.ajax({
        type: 'POST',
        url: url,
        data: {
            'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val(),
            'post_id':post_id,
        }, 
        success: function(data) {
            console.log(data['downvote'], '*************')
            if (parseInt(data['downvote']) > 0) {
                $(`.downvote-count${post_id}`).html(parseInt(data['downvote']))
                console.log(parseInt(data['downvote']), '*************')
            }
            else {
                $(`.downvote-count${post_id}`).html(0) // if the downvote is undefined, it will show 0
                console.log(parseInt(data['downvote']), '*************')
            }
        },
        })
    
    })
</script>